apiVersion: batch/v1
kind: Job
metadata:
  name: kube-certs-health-check
  namespace: kube-certs
spec:
  template:
    metadata:
      labels:
        app: kube-certs
        component: certificate-scan
    spec:
      serviceAccountName: kube-certs-sa
      restartPolicy: Never
      # Init container to ensure parent directory exists (required for DirectoryOrCreate to work)
      initContainers:
      - name: setup-certs-parent
        image: busybox:latest
        command: ['sh', '-c']
        args:
          - |
            # Ensure /etc/kubernetes exists so DirectoryOrCreate can create /etc/kubernetes/pki
            mkdir -p /host/etc/kubernetes
            echo "Parent directory verified"
        volumeMounts:
        - name: kube-certs-parent
          mountPath: /host/etc/kubernetes
        securityContext:
          runAsUser: 0
          privileged: true
      containers:
      # Certificate scanner container
      - name: cert-scanner
        image: kube-certs-manager:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            python -c "
            import json
            import sys
            sys.path.insert(0, '/app')
            from certs_analyzer import CertificateScanner
            
            scanner = CertificateScanner('/etc/kubernetes/pki')
            results = scanner.scan_cluster_certificates()
            scanner.save_results('/tmp/cert-scan-results/results.json')
            print('Certificate scan complete. Results written to /tmp/cert-scan-results/results.json')
            "
        volumeMounts:
        - name: cert-scan-results
          mountPath: /tmp/cert-scan-results
        - name: kube-certs
          mountPath: /etc/kubernetes/pki
          readOnly: true
        - name: minikube-certs
          mountPath: /var/lib/minikube/certs
          readOnly: true
        env:
        - name: PYTHONPATH
          value: "/app"
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Need write access for temp files
          capabilities:
            drop:
            - ALL
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "512Mi"
            cpu: "500m"
      
      # Slack notification sidecar container
      - name: slack-notifier
        image: kube-certs-manager:latest
        env:
        - name: SLACK_BOT_TOKEN
          valueFrom:
            secretKeyRef:
              name: slack-credentials
              key: slack-bot-token
        - name: SLACK_CHANNEL
          value: "#kube-certs"
        - name: CERT_SCAN_OUTPUT_DIR
          value: "/tmp/cert-scan-results"
        - name: OPENAI_API_KEY
          valueFrom:
            secretKeyRef:
              name: slack-credentials
              key: openai-api-key
              optional: true
        volumeMounts:
        - name: cert-scan-results
          mountPath: /tmp/cert-scan-results
        resources:
          requests:
            memory: "64Mi"
            cpu: "50m"
          limits:
            memory: "128Mi"
            cpu: "100m"
      
      volumes:
      - name: cert-scan-results
        emptyDir: {}
      - name: kube-certs-parent
        hostPath:
          path: /etc/kubernetes
          type: DirectoryOrCreate
      - name: kube-certs
        hostPath:
          path: /etc/kubernetes/pki
          type: DirectoryOrCreate
      - name: minikube-certs
        hostPath:
          path: /var/lib/minikube/certs
          type: DirectoryOrCreate
      
      nodeSelector:
        kubernetes.io/os: linux
        # Optional: Only run on control plane nodes (uncomment if you have node labels)
        # node-role.kubernetes.io/control-plane: ""

